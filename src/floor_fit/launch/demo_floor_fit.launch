<launch> 
  <!-- Complete demo with input node and rviz - might not work if your system is set up differently -->
  
  <!-- Input -->
  <include file="$(find livox_ros_driver)/launch/livox_lidar.launch" />
  
  <!-- Processing -->
  <!-- See https://github.com/methylDragon/pcl-ros-tutorial/blob/master/Starter%20Code/demo_code/pcl_tester/launch/floor_segmentation.launch for another example -->
  <arg name="cloud_topic" default="/livox/lidar" />
  <node pkg="nodelet" type="nodelet" name="pcl_manager" args="manager" output="screen" />

  <!-- VoxelGrid filter for downsampling, and removing the ceiling-->
  <node pkg="nodelet" type="nodelet" name="filter" args="load pcl/VoxelGrid pcl_manager" output="screen">
    <remap from="~input" to="$(arg cloud_topic)" />
    <rosparam>
      filter_field_name: z
      filter_limit_min: -3.0
      filter_limit_max: 1.0
      filter_limit_negative: False
      leaf_size: 0.10
    </rosparam>
  </node>

  <!-- Calculate normals-->
  <node pkg="nodelet" type="nodelet" name="normal_calculator" args="load pcl/NormalEstimation pcl_manager" output="screen">
    <remap from="~input" to="/filter/output" />
    <rosparam>
      k_search: 12
      radius_search: 0
      spatial_locator: 0 # 0 (ANN), 1 (FLANN), 2 (organized)
    </rosparam>
  </node>

  <!-- SAC Fitting of the floor plane -->
  <node pkg="nodelet" type="nodelet" name="fitter" args="load pcl/SACSegmentationFromNormals pcl_manager" output="screen">
    <remap from="~input"   to="/filter/output" />
    <remap from="~normals" to="/normal_calculator/output" />
    <rosparam>
      model_type: 11 # 11: SACMODEL_NORMAL_PLANE
      axis: [0.0,0.0,1.0]
      eps_angle: 0.10
      distance_threshold: 0.10
      max_iterations: 1000
      method_type: 0
      optimize_coefficients: true
      normal_distance_weight: 0.1
    </rosparam>
  </node>

  <!-- Extract point within plane and the others -->
  <node pkg="nodelet" type="nodelet" name="extractor_plane" args="load pcl/ExtractIndices pcl_manager" output="screen">
    <remap from="~input"   to="/filter/output" />
    <remap from="~indices" to="/fitter/inliers" />
    <rosparam>
      negative: false
      approximate_sync: true
    </rosparam>
  </node>
  <node pkg="nodelet" type="nodelet" name="extractor_objs" args="load pcl/ExtractIndices pcl_manager" output="screen">
    <remap from="~input"   to="/filter/output" />
    <remap from="~indices" to="/fitter/inliers" />
    <rosparam>
      negative: true
      approximate_sync: true
    </rosparam>
  </node>
  
  <!-- Compute the convex hull of the plane points -->
  <node pkg="nodelet" type="nodelet" name="convex_hull" args="load pcl/ConvexHull2D pcl_manager" output="screen">
    <remap from="~input" to="/extractor_plane/output" />
  </node>
  
  <node pkg="floor_fit" type="visualizor" name="visualizor" output="screen">
    <remap from="/model" to="/fitter/model" />
    <remap from="/marker" to="/floor" />
  </node>

  <!-- Output, i.e. rviz -->
  
  <node type="rviz" name="rviz" pkg="rviz" args="-d $(find floor_fit)/rviz/rviz.rviz" required="true" />
  
</launch>
